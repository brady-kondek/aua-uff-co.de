<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/path/to/ruby</span>
<span class="n">symbolhash</span> <span class="o">=</span> <span class="p">{</span><span class="no">SP</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="no">LCL</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="no">ARG</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="no">THIS</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="no">THAT</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="no">R0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="no">R1</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="no">R2</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="no">R3</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="no">R4</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> 
              <span class="no">R5</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="no">R6</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="no">R7</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="no">R8</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="no">R9</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="no">R10</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="no">R11</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span> <span class="no">R12</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="no">R13</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span> <span class="no">R14</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span> 
              <span class="no">R15</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span> <span class="no">SCREEN</span><span class="p">:</span> <span class="mi">16384</span><span class="p">,</span> <span class="no">KBD</span><span class="p">:</span> <span class="mi">24576</span><span class="p">}</span>

<span class="n">comphash</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"0"</span><span class="p">:</span> <span class="s2">"0101010"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">:</span> <span class="s2">"0111111"</span><span class="p">,</span> <span class="s2">"-1"</span><span class="p">:</span> <span class="s2">"0111010"</span><span class="p">,</span> <span class="no">D</span><span class="p">:</span> <span class="s2">"0001100"</span><span class="p">,</span> <span class="no">A</span><span class="p">:</span> <span class="s2">"0110000"</span><span class="p">,</span>
            <span class="s2">"!D"</span><span class="p">:</span> <span class="s2">"0001101"</span><span class="p">,</span> <span class="s2">"!A"</span><span class="p">:</span> <span class="s2">"0110001"</span><span class="p">,</span> <span class="s2">"-D"</span><span class="p">:</span> <span class="s2">"0001111"</span><span class="p">,</span> <span class="s2">"-A"</span><span class="p">:</span> <span class="s2">"0110011"</span><span class="p">,</span> 
            <span class="s2">"D+1"</span><span class="p">:</span> <span class="s2">"0011111"</span><span class="p">,</span> <span class="s2">"A+1"</span><span class="p">:</span> <span class="s2">"0110111"</span><span class="p">,</span> <span class="s2">"D-1"</span><span class="p">:</span> <span class="s2">"0001110"</span><span class="p">,</span> <span class="s2">"A-1"</span><span class="p">:</span> <span class="s2">"0110010"</span><span class="p">,</span> 
            <span class="s2">"D+A"</span><span class="p">:</span> <span class="s2">"0000010"</span><span class="p">,</span> <span class="s2">"D-A"</span><span class="p">:</span> <span class="s2">"0010011"</span><span class="p">,</span> <span class="s2">"A-D"</span><span class="p">:</span> <span class="s2">"0000111"</span><span class="p">,</span> <span class="s2">"D&amp;A"</span><span class="p">:</span> <span class="s2">"0000000"</span><span class="p">,</span> 
            <span class="s2">"D|A"</span><span class="p">:</span> <span class="s2">"0010101"</span><span class="p">,</span> <span class="no">M</span><span class="p">:</span> <span class="s2">"1110000"</span><span class="p">,</span> <span class="s2">"!M"</span><span class="p">:</span> <span class="s2">"1110001"</span><span class="p">,</span> <span class="s2">"-M"</span><span class="p">:</span> <span class="s2">"1110011"</span><span class="p">,</span> 
            <span class="s2">"M+1"</span><span class="p">:</span> <span class="s2">"1110111"</span><span class="p">,</span> <span class="s2">"M-1"</span><span class="p">:</span> <span class="s2">"1110010"</span><span class="p">,</span> <span class="s2">"D+M"</span><span class="p">:</span> <span class="s2">"1000010"</span><span class="p">,</span> <span class="s2">"D-M"</span><span class="p">:</span> <span class="s2">"1010011"</span><span class="p">,</span> 
            <span class="s2">"M-D"</span><span class="p">:</span> <span class="s2">"1000111"</span><span class="p">,</span> <span class="s2">"D&amp;M"</span><span class="p">:</span> <span class="s2">"1000000"</span><span class="p">,</span> <span class="s2">"D|M"</span><span class="p">:</span> <span class="s2">"1010101"</span><span class="p">}</span>

<span class="n">desthash</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"0"</span><span class="p">:</span> <span class="s2">"000"</span><span class="p">,</span> <span class="no">M</span><span class="p">:</span> <span class="s2">"001"</span><span class="p">,</span> <span class="no">D</span><span class="p">:</span> <span class="s2">"010"</span><span class="p">,</span> <span class="no">MD</span><span class="p">:</span> <span class="s2">"011"</span><span class="p">,</span> <span class="no">A</span><span class="p">:</span> <span class="s2">"100"</span><span class="p">,</span> <span class="no">AM</span><span class="p">:</span> <span class="s2">"101"</span><span class="p">,</span> <span class="no">AD</span><span class="p">:</span> <span class="s2">"110"</span><span class="p">,</span> 
            <span class="no">AMD</span><span class="p">:</span> <span class="mi">111</span><span class="p">}</span>

<span class="n">jumphash</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"0"</span><span class="p">:</span> <span class="s2">"000"</span><span class="p">,</span> <span class="no">JGT</span><span class="p">:</span> <span class="s2">"001"</span><span class="p">,</span> <span class="no">JEQ</span><span class="p">:</span> <span class="s2">"010"</span><span class="p">,</span> <span class="no">JGE</span><span class="p">:</span> <span class="s2">"011"</span><span class="p">,</span> <span class="no">JLT</span><span class="p">:</span> <span class="s2">"100"</span><span class="p">,</span> <span class="no">JNE</span><span class="p">:</span> <span class="s2">"101"</span><span class="p">,</span> 
            <span class="no">JLE</span><span class="p">:</span> <span class="s2">"110"</span><span class="p">,</span> <span class="no">JMP</span><span class="p">:</span> <span class="s2">"111"</span><span class="p">}</span>

<span class="n">output_file</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="no">ARGV</span><span class="p">.</span><span class="nf">first</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="no">File</span><span class="p">.</span><span class="nf">basename</span><span class="p">(</span><span class="no">ARGV</span><span class="p">.</span><span class="nf">first</span><span class="p">)</span> <span class="o">+</span> <span class="s2">".hack"</span>
<span class="n">file</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="no">ARGV</span><span class="p">.</span><span class="nf">first</span><span class="p">)</span>
<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">next_address</span> <span class="o">=</span> <span class="mi">16</span>

<span class="n">file</span><span class="p">.</span><span class="nf">each_line</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
  <span class="k">next</span> <span class="k">unless</span> <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="sr">/[[:space:]]/</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
                         <span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"//"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

  <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/@.+/</span><span class="p">)</span> <span class="o">||</span> 
     <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/.+=.+/</span><span class="p">)</span> <span class="o">||</span> 
     <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/.+;.+/</span><span class="p">)</span> <span class="o">||</span> 
     <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/.+=.+;.+/</span><span class="p">)</span>
    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">end</span>

  <span class="k">if</span> <span class="n">match</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/\((?&lt;label&gt;.+)\)/</span><span class="p">)</span>
    <span class="k">unless</span> <span class="n">symbolhash</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="ss">:label</span><span class="p">].</span><span class="nf">to_sym</span><span class="p">]</span>
      <span class="n">symbolhash</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="ss">:label</span><span class="p">].</span><span class="nf">to_sym</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">File</span><span class="p">.</span><span class="nf">delete</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span> <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">exists?</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>

<span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">output</span><span class="o">|</span>
  <span class="n">file</span><span class="p">.</span><span class="nf">each_line</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
    <span class="k">next</span> <span class="k">unless</span> <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">gsub</span><span class="p">(</span><span class="sr">/[[:space:]]/</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
                           <span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"//"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">match</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/@(?&lt;addr&gt;.+)/</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/@(\D+)/</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">address</span> <span class="o">=</span> <span class="n">symbolhash</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="ss">:addr</span><span class="p">].</span><span class="nf">to_sym</span><span class="p">]</span>
          <span class="n">output</span><span class="p">.</span><span class="nf">puts</span> <span class="n">address</span><span class="p">.</span><span class="nf">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">rjust</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="n">symbolhash</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="ss">:addr</span><span class="p">].</span><span class="nf">to_sym</span><span class="p">]</span> <span class="o">=</span> <span class="n">next_address</span>
          <span class="n">output</span><span class="p">.</span><span class="nf">puts</span> <span class="n">next_address</span><span class="p">.</span><span class="nf">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">rjust</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span>
          <span class="n">next_address</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">end</span>
      <span class="k">else</span>
        <span class="n">output</span><span class="p">.</span><span class="nf">puts</span> <span class="n">match</span><span class="p">[</span><span class="ss">:addr</span><span class="p">].</span><span class="nf">to_i</span><span class="p">.</span><span class="nf">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">rjust</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="n">match</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/(?&lt;dest&gt;.+)=(?&lt;comp&gt;.+)/</span><span class="p">)</span>
      <span class="n">output</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"111"</span> <span class="o">+</span> <span class="n">comphash</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="ss">:comp</span><span class="p">].</span><span class="nf">to_sym</span><span class="p">]</span> <span class="o">+</span>
                          <span class="n">desthash</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="ss">:dest</span><span class="p">].</span><span class="nf">to_sym</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"000"</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="n">match</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/(?&lt;comp&gt;.+);(?&lt;jump&gt;.+)/</span><span class="p">)</span>
      <span class="n">output</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"111"</span> <span class="o">+</span> <span class="n">comphash</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="ss">:comp</span><span class="p">].</span><span class="nf">to_sym</span><span class="p">]</span> <span class="o">+</span>
                  <span class="s2">"000"</span> <span class="o">+</span> <span class="n">jumphash</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="ss">:jump</span><span class="p">].</span><span class="nf">to_sym</span><span class="p">]</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="n">match</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/(?&lt;dest&gt;.+)=(?&lt;comp&gt;.+);(?&lt;jump&gt;.+)/</span><span class="p">)</span>
      <span class="n">output</span><span class="p">.</span><span class="nf">puts</span> <span class="s2">"111"</span> <span class="o">+</span> <span class="n">comphash</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="ss">:comp</span><span class="p">].</span><span class="nf">to_sym</span><span class="p">]</span> <span class="o">+</span>
                          <span class="n">desthash</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="ss">:dest</span><span class="p">].</span><span class="nf">to_sym</span><span class="p">]</span> <span class="o">+</span>
                          <span class="n">jumphash</span><span class="p">[</span><span class="n">match</span><span class="p">[</span><span class="ss">:jump</span><span class="p">].</span><span class="nf">to_sym</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
